name: Build

on:
  workflow_call:
    inputs:
      env-upper:
        required: true
        type: string
      env-lower:
        required: true
        type: string
      triggered:
        required: true
        type: boolean

jobs:
  build:
    name: ${{ inputs.env-upper }} - Build dependencies & create artifact
    runs-on: ubuntu-latest
    environment: ${{ inputs.env-lower }}
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    if: inputs.triggered == true

    steps:
      - name: Checkout the repository 🎁
        uses: actions/checkout@v4

      - name: Test
        run: |
          echo 'Provider : ' $PROVIDER
          echo 'SA : ' $SA
          echo 'GCP Project : ' $GCP_PROJECT
        env:
          PROVIDER: ${{ secrets[format('WI_PROVIDER_V2_{0}', inputs.env-upper)] }}
          SA: ${{ secrets[format('WI_SA_V2_{0}', inputs.env-upper)] }}
          GCP_PROJECT: ${{ secrets[format('GCP_PROJECT_{0}', inputs.env-upper)] }}

      - name: Auth GCP
        uses: ./.github/actions/auth-gcp
        with:
          auth-mode: "workload-federation"
          provider: ${{ secrets[format('WI_PROVIDER_V2_{0}', inputs.env-upper)] }}
          service-account: ${{ secrets[format('WI_SA_V2_{0}', inputs.env-upper)] }}
          registry-login: true
          setup-gcloud: true

      - name: Write .env file
        run: gcloud --quiet beta secrets versions access latest --project=$GCP_PROJECT --secret="module-env" > .env
        env:
          GCP_PROJECT: ${{ secrets[format('GCP_PROJECT_{0}', inputs.env-upper)] }}

      - name: Install composer dependencies
        run: composer install --no-dev -o
