name: PrestaShop 1.7 - Deployment

on:
  pull_request:
    types: [opened, reopened, synchronize, edited, labeled]
  push:
    tags:
      - v7.*
    branches:
      - prestashop/1.7.x

jobs:
  push-to-repository-matrix:
    name: ${{ matrix.env.upper }} - Push to GitHub repository
    strategy:
      fail-fast: false
      matrix:
        env:
          - upper: INTEGRATION
            lower: integration
            triggered: ${{ contains(github.event.pull_request.labels.*.name, 'integration deployment') }}
          - upper: PREPRODUCTION
            lower: preproduction
            triggered: ${{ contains(github.event.pull_request.labels.*.name, 'preproduction deployment') }}
          - upper: PRODUCTION
            lower: production
            triggered: ${{ github.event_name == 'push' }}
    uses: ./.github/workflows/push-to-repository.yml
    with:
      env-upper: ${{ matrix.env.upper }}
      env-lower: ${{ matrix.env.lower }}
      triggered: ${{ matrix.env.triggered }}
      repository-name: ${{ github.event.repository.name }}
      prestashop-version: ps7
      pr-number: pr${{ github.event.number }}
    secrets: inherit

  push-to-bucket-matrix:
    name: ${{ matrix.env.upper }} - Push to GCP bucket storage
    needs: [push-to-repository-matrix]
    strategy:
      fail-fast: false
      matrix:
        env:
          - lower: integration
            upper: INTEGRATION
            triggered: ${{ contains(github.event.pull_request.labels.*.name, 'integration deployment') }}
          - lower: preproduction
            upper: PREPRODUCTION
            triggered: ${{ contains(github.event.pull_request.labels.*.name, 'preproduction deployment') }}
          - upper: PRODUCTION
            lower: production
            triggered: ${{ github.event_name == 'push' }}
    uses: ./.github/workflows/push-to-bucket.yml
    with:
      env-upper: ${{ matrix.env.upper }}
      env-lower: ${{ matrix.env.lower }}
      triggered: ${{ matrix.env.triggered }}
      repository-name: ${{ github.event.repository.name }}
      prestashop-version: ps7
      pr-number: pr${{ github.event.number }}
    secrets: inherit

  update-release-draft:
    name: PRODUCTION - Update release draft
    needs: [push-to-repository-matrix]
    uses: ./.github/workflows/update-release-draft.yml
    with:
      env-lower: production
      triggered: ${{ github.event_name == 'push' }}
      repository-name: ${{ github.event.repository.name }}
    secrets: inherit
