name: Publish to the Marketplace

on:
  release:
    types: [released]

jobs:
  publish_to_marketplace:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        version: [7, 8, 9]

    steps:
      - name: Checkout
        uses: actions/checkout@v2.0.0

      - name: Generate clean tag name
        id: clean-tag
        run: |
          RELEASE_TAG="${{ github.event.release.tag_name }}"
          # Remove 'v' prefix if present (e.g., v1.0.0 -> 1.0.0)
          RELEASE_TAG_CLEAN=$(echo "$RELEASE_TAG" | sed 's/^v//')
          echo "clean_tag=$RELEASE_TAG_CLEAN" >> $GITHUB_OUTPUT

      - name: Download release asset
        uses: dsaltares/fetch-gh-release-asset@0.0.4
        with:
          repo: ${{ github.event.repository.full_name }}
          version: ${{ github.event.release.id }}
          file: ps_checkout-v${{ matrix.version }}.${{ steps.clean-tag.outputs.clean_tag }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare publishing tool
        run: |
          composer global require prestashop/publish-on-marketplace

      - name: Release zip
        run: |
          ~/.composer/vendor/bin/publish-on-marketplace --archive=$PWD/ps_checkout-v${{ matrix.version }}.${{ steps.clean-tag.outputs.clean_tag }}.zip --metadata-json=$PWD/.github/mktp-metadata.json --changelog="${{ github.event.release.body }}" --debug
        env:
          MARKETPLACE_API_KEY: ${{ secrets.MARKETPLACE_API_KEY }}